---
# Copyright 2018, OpenNext SAS
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
# Create an admin user

- name: create openstack cephx key(s)
  ceph_key:
    state: present
    name: "{{ telegraf_cephx.name }}"
    caps: "{{ telegraf_cephx.caps }}"
    secret: "{{ telegraf_cephx.key | default('') }}"
    containerized: "{{ hostvars[groups[mon_group_name][0]]['docker_exec_cmd'] | default('') }}"
    cluster: "{{ fsid }}"
    mode: "{{ telegraf_cephx.mode|default(omit) }}"
  delegate_to: "{{ groups['ceph-mon'][0] }}"

- name: fetch openstack cephx key(s)
  fetch:
    src: "/etc/ceph/{{ fsid }}.{{ telegraf_cephx.name }}.keyring"
    dest: "{{ fetch_directory }}/{{ fsid }}/etc/ceph/{{ cluster }}.{{ telegraf_cephx.name }}.keyring"
    flat: yes
    fail_on_missing: yes
  delegate_to: "{{ groups['ceph-mon'][0] }}"

- name: copy telegraf cephx key to other mons and osd hosts
  copy:
    src: "{{ fetch_directory }}/{{ fsid }}/etc/ceph/{{ cluster }}.{{Â telegraf_cephx.name }}.keyring"
    dest: "/etc/ceph/{{ cluster }}.{{ telegraf_cephx.name }}.keyring"
    owner: telegraf
    group: telegraf
    mode: "{{ telegraf_cephx.mode|default(omit) }}"
  delegate_to: "{{ groups['ceph-mon', 'ceph-osd'] }}"